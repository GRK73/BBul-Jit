<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOOP 방송 일정표</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @font-face {
            font-family: 'planb';
            src: url('./planb.dc617619.otf') format('opentype');
        }

        :root {
            --bg-dark: #0a0a0a;
            --border-white: #ffffff;
            --text-white: #ffffff;
            --accent-color: #31982f;
        }

        body {
            font-family: 'Pretendard', -apple-system, system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 컨트롤 패널 */
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            width: 1000px;
        }

        .streamer-tabs {
            display: flex;
            gap: 5px;
            background: #333;
            padding: 5px;
            border-radius: 8px;
        }

        .tab-btn {
            padding: 8px 15px;
            border: none;
            background: transparent;
            color: #ccc;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: white;
            font-weight: bold;
        }

        .action-btn {
            padding: 8px 20px;
            border: 1px solid #555;
            background: #444;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }

        .action-btn:hover { background: #555; }

        /* 캡처 영역 */
        #capture-area {
            background-color: var(--bg-dark);
            padding: 40px;
            border: 2px solid var(--border-white);
            width: 1000px;
            box-sizing: border-box;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo {
            font-family: 'planb', sans-serif;
            font-size: 40px;
            letter-spacing: 2px;
        }

        .schedule-title {
            font-size: 24px;
            font-weight: bold;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid var(--border-white);
        }

        .day-header {
            padding: 10px;
            text-align: center;
            background: #222;
            border-bottom: 1px solid var(--border-white);
            border-right: 1px solid var(--border-white);
            font-weight: bold;
        }

        .day-cell {
            height: 120px;
            border-right: 1px solid var(--border-white);
            border-bottom: 1px solid var(--border-white);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .day-cell:nth-child(7n) { border-right: none; }

        .event-item {
            font-size: 14px;
            padding: 4px 8px;
            background: #333;
            border-radius: 3px;
            border-left: 3px solid var(--accent-color);
        }

        /* 관리자 모드 */
        .admin-section {
            margin-top: 20px;
            padding: 15px;
            background: #222;
            border-radius: 8px;
            width: 1000px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-only { display: none; }

        [contenteditable="true"] {
            outline: 1px dashed #555;
            padding: 2px;
        }

        [contenteditable="true"]:focus {
            outline: 2px solid var(--accent-color);
            background: #111;
        }
    </style>
</head>
<body>

    <div class="controls">
        <div class="streamer-tabs" id="streamerTabs">
            <!-- 스트리머 버튼들이 여기에 동적으로 추가됨 -->
        </div>
        <button class="action-btn" onclick="saveAsImage()">이미지로 저장</button>
    </div>

    <div id="capture-area">
        <div class="header">
            <div class="logo">SCHEDULE</div>
            <div class="schedule-title" id="currentStreamerName">스트리머 일정</div>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            <!-- 요일 헤더 -->
            <div class="day-header">SUN</div><div class="day-header">MON</div><div class="day-header">TUE</div>
            <div class="day-header">WED</div><div class="day-header">THU</div><div class="day-header">FRI</div>
            <div class="day-header">SAT</div>
            <!-- 날짜 셀들이 여기에 동적으로 추가됨 -->
        </div>
    </div>

    <div class="admin-section">
        <input type="password" id="adminPassword" placeholder="관리자 비밀번호">
        <button class="action-btn" onclick="checkAdmin()">관리자 로그인</button>
        <span id="adminStatus" style="font-size: 14px; color: #888;">상태: 읽기 전용</span>
        <button class="action-btn admin-only" onclick="saveData()">변경사항 저장</button>
    </div>

    <script>
        let scheduleData = {}; // data.json에서 로드할 데이터
        let currentStreamer = "";

        // 초기화
        async function init() {
            try {
                const response = await fetch('data.json');
                scheduleData = await response.json();
                
                // 스트리머 목록 생성
                const tabs = document.getElementById('streamerTabs');
                Object.keys(scheduleData.schedules).forEach((id, index) => {
                    const btn = document.createElement('button');
                    btn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
                    btn.innerText = id;
                    btn.onclick = () => switchStreamer(id);
                    tabs.appendChild(btn);
                    if (index === 0) currentStreamer = id;
                });

                renderCalendar();
            } catch (e) {
                console.error("데이터를 불러올 수 없습니다. (data.json 확인 필요)");
            }
        }

        function switchStreamer(id) {
            currentStreamer = id;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('currentStreamerName').innerText = `${id} 방송 일정`;
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            // 헤더 제외하고 초기화
            const headers = Array.from(grid.querySelectorAll('.day-header'));
            grid.innerHTML = "";
            headers.forEach(h => grid.appendChild(h));

            // 이번 주 날짜 계산 (예시로 7일치만 생성)
            const today = new Date();
            const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.innerHTML = `<span style="font-size: 12px; color: #666;">${date.getMonth()+1}/${date.getDate()}</span>`;
                
                // 해당 날짜의 일정 추가
                const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                const events = (scheduleData.schedules[currentStreamer] || []).filter(e => e.date === dateStr);
                
                events.forEach(ev => {
                    const item = document.createElement('div');
                    item.className = 'event-item';
                    item.contentEditable = document.getElementById('adminStatus').innerText.includes('관리자');
                    item.innerText = `[${ev.time}] ${ev.content}`;
                    cell.appendChild(item);
                });

                grid.appendChild(cell);
            }
        }

        function checkAdmin() {
            const pw = document.getElementById('adminPassword').value;
            if (pw === "PBT5212") {
                document.getElementById('adminStatus').innerText = "상태: 관리자 모드";
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                renderCalendar(); // 편집 가능하게 다시 렌더링
                alert("관리자 모드 활성화!");
            } else {
                alert("비밀번호가 틀렸습니다.");
            }
        }

        function saveAsImage() {
            const area = document.getElementById('capture-area');
            html2canvas(area, { backgroundColor: '#0a0a0a' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `schedule_${currentStreamer}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function saveData() {
            alert("서버 저장 기능은 백엔드 스크립트(bot.js)에서 처리됩니다.");
        }

        init();
    </script>
</body>
</html>
